Cимуляция робота с дифференциальным приводом
===
---
##Управление
Управление осуществляется с помощью модуля `turtlebot3_teleop`

Данный модуль публикует управляющие команды в _topic_ `/cmd_vel` в формате `geometry_msgs/Twist`

Для считывания команд управления узел подписывается к `/cmd_vel`
```python
rospy.Subscriber("cmd_vel", Twist, ctrl_callback)
```
Команды управления представляют собой две скорости - линейную и угловую

Для реализации дифференциального управления следует подавать команды на колёса следующим образом:

левое = линейная + угловая  
правое = линейная - угловая

Функция `ctrl_callback` записывает команды в переменные для дальнейшей обработки
```python
def ctrl_callback(data):
    global robot_com, robot_wheels
    robot_com = data
    robot_wheels[0].target_vel = data.linear.x - data.angular.z*5
    robot_wheels[1].target_vel = data.linear.x + data.angular.z*5
```

##Модель моторов
### Класс
Для моелирования скорости в зависимости от сигнала управления взято апериодическое звено k/(Ts+1)  
Также для удобства дальнейшего использования написан класс Wheel моделирующий моторы
```python
class Wheel:
    def __init__(self):
        self.k = 4
        self.integral = 0
        self.curr_vel = 0
        self.target_vel = 0
        self.T = 0.1

    def step(self, dt):
        err = self.target_vel - self.curr_vel
        self.integral += err * dt
        self.curr_vel += err * self.k / (abs(self.integral) * self.T + 1) * dt
```
### Тестирование модели
На рисунке изображена переходная характеристика одного мотора с входным сигналом:
* 0.26 на промежутке времени от 0с до 2с (0-200 на графике) 
* -0.26 от 2с до 4с (200-400 на графике)

![alt text](https://github.com/MarkT5/robot_odom_sim/blob/main/img/model_test.png "motor model")

## Перемещение
Расчёт текущей координаты происходит итеративно в несколько шагов
1. Расчёт текущего положения енкодеров
  - Шаг модели моторов
  - угловая скорость * dt
  - положение (в радианах) /(2*pi)*4096
2. Расчёт мгновенного линейного и углового перемещений
  - линейное: (d левое + d правое)/2
  - угловое: atan((d правое-d левое)/L)

![alt_text](https://github.com/MarkT5/robot_odom_sim/blob/main/img/delta_calc.png "Расчёт мгновенных перемещений")

3. Расчитанные мгновенные перемещения прибавляются к прошлому положению (с учётом текущего поворота)

## Отображение рузультатов
### RViz
1. Для отображения полодения используется объект Pose, считывающий данные из указанного источника в формате `geometry_msgs/PoseStamped`
2. Для отображения маршрута используется объект Path, считывающий данные из указанного источника в формате `nav_msgs/Path`, представляющем из себя массив положений `Pose`

Результат приведён на изображении ниже
![alt_text](https://github.com/MarkT5/robot_odom_sim/blob/main/img/Screenshot%20from%202023-05-21%2003-03-29.png, "результат моделирования")

## Запуск
После успешной установки ROS и моделей turtlebot3 и turtlebot3_msgs из дериктории `~catkin_ws/src` выполнить команду
```
git clone https://github.com/MarkT5/robot_odom_sim
```
После чего выполнить команду `catkin_make`

Пакет готов к запуску  
Чтобы произвести запуск вводятся следующие команды:
```
export TURTLEBOT3_MODEL=waffle
roslaunch robot_odom_sim demo.launch
```
После чего откроется окно RViz  
Управление производится с помощью клавиш wasd в командном окне, в котором была запущена программа
